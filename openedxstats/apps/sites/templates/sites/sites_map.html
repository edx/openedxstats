{% extends "base.html" %}
{% load staticfiles %}
{% block title %} Open edX Sites Map {% endblock %}
{% block bootstrap3_extra_head %}

<link rel="shortcut icon" href="{%  static 'sites/favicon.ico' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js" integrity="sha512-WXoSHqw/t26DszhdMhOXOkI7qCiv5QWXhH9R7CgvgZMHz1ImlkVQ3uNsiQKu5wwbbxtPzFXd1hK4tzno2VqhpA==" crossorigin=""></script>
<link rel="stylesheet" href="{% static 'sites/screen.css' %}" />
<link rel="stylesheet" href="{% static 'sites/MarkerCluster.css' %}" />
<link rel="stylesheet" href="{% static 'sites/MarkerCluster.Default.css' %}" />
<script type="text/javascript" language="javascript" src="{% static 'sites/leaflet.markercluster-src.js' %}"></script>
<script type="text/javascript" language="javascript" src="{% static 'sites/allCountries.js' %}"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/u/bs/dt-1.10.12/datatables.min.css"/>
<script type="text/javascript" src="https://cdn.datatables.net/u/bs/dt-1.10.12/datatables.min.js"></script>
{% endblock %}

{% block content %}
{% include "navbar.html" %}

<body>

        <style>
                #map {
                    width: 50%;
                    height: 500px;
                    border: 1px solid #ccc;
                    float: left;
                }
                .table-container {
                    margin-left: 20px;
                    width: 100px;
                    float: left;
                }


        </style>
        <h1 id='country-name'></h1>
        <div id="map">

        </div>



        <script type="text/javascript">

            $(document).ready(function () {
                // Nav active class selection
                var url = window.location;
                $('ul.nav.navbar-nav li a[href="' + url.pathname + '"]').parent().addClass('active');
                // Tooltips
                $('[data-toggle="tooltip"]').tooltip();
                // Table sorting

                //    isCurrentVersion
                //    Determine rendering of green check box based on whether site is of the current version based on the sites active end date for each row
                isCurrentVersion = activeEndDate => activeEndDate ? '<span class="glyphicon glyphicon-ok" aria-hidden="true" style="color: green; font-size: 30px;"></span>' : ''

                //    renderActionButtons
                //    Accepts arguments of the site ID and the website's active end date to determine which buttons to render inside the row under column 'Actions'
                //    At minimum will render the button for 'Detail' and 'Delete', 'Update' will be rendered if website is still active.
                function renderActionButtons(siteId, activeEndDate) {
                    const detail_site = `<td class="action-button-cell"><a href="/sites/site_detail/${siteId}"><button type="button" class="btn btn-primary" aria-label="Detail" data-toggle="tooltip" data-placement="bottom" title="Detail"><span class="glyphicon glyphicon-list" aria-hidden="true"></span></button></a></td>`
                    const update_site = `<td class="action-button-cell"><a href="/sites/update_site/${siteId}"><button type="button" class="btn btn-primary" aria-label="Edit" data-toggle="tooltip" data-placement="bottom" title="Edit"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button></a></td>`
                    const delete_site = `<td class="action-button-cell"><a href="/sites/delete_site/${siteId}"><button type="button" class="btn btn-danger" aria-label="Delete" data-toggle="tooltip" data-placement="bottom" title="Delete"><span class="glyphicon glyphicon-trash"></span></button></a></td>`
                    return `<td style="width: 1%; vertical-align: middle;"><table><tr>${detail_site + (!activeEndDate ? update_site : '') + delete_site}</tr></table></td>`
                }

                //  renderUrlString
                //  Converts site URL into HTML link tag
                renderUrlString = url => `<a href="${url}">${url}</a>`

                //    Datatables configuration
                //    Data is retrieved the API end point served from the view 'sites_list_json' (see views.py)
                var sitesTable = $('#sites').DataTable({
                    "searching": true,
                    "processing": true,
                    "ajax":{
                        "url":"{% url 'sites:sites_list_json' %}", // Communicating to API endpoint serving JSON data from database
                        "dataSrc": function(json) {                // Formatting data to be compatible with DataTables
                            const data = JSON.parse(json.sites);
                            console.log(data);
                            Object.keys(data).forEach(function(siteID) {
                                const site = data[siteID];
                                // Rendering of elements for columns 'Current Version?' & 'Actions'
                                site.fields['isCurrentVersion'] = isCurrentVersion(site.fields.active_end_date);
                                site.fields['actionButtons'] = renderActionButtons(site.pk, site.fields.active_end_date);
                                site.fields['urlString'] = renderUrlString(site.fields.url);
                            })
                            return data;
                        }},
                    "columns": [                                    // Data for each row item from JSON
                         { "data": "fields.site_type" },
                         { "data": "fields.name" },
                         { "data": "fields.urlString" },
                         { "data": "fields.course_count" }
                    ]
                });


                $('#dateSearchButton').on('click', sitesTable.draw);
                $('#latestOnly').on('click', sitesTable.draw);
                $('#hideZeros').on('click', sitesTable.draw);
                $('#dateInput').keyup(function (e) {
                    if (e.keyCode == 13) {
                        sitesTable.draw()
                    }
                });
            });

            // Filtering
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                var goodDate, goodCourses;

                var latestOnly = $("#latestOnly").prop("checked") && !$('#dateInput').val();
                if (latestOnly) {
                    goodDate = isNaN(Date.parse(data[5]));
                }
                else {
                    goodDate = Date.parse(data[4]) <= Date.parse($('#dateInput').val() || data[4])
                        && (Date.parse($('#dateInput').val() || data[5]) <= Date.parse(data[5])
                            || isNaN(Date.parse(data[5])));
                }

                var hideZeros = $("#hideZeros").prop("checked");
                if (hideZeros) {
                    goodCourses = data[3] !== "0";
                }
                else {
                    goodCourses = true;
                }
                console.log('Filter data', data);
                return data
            });


            var tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 5,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }),
                latlng = new L.LatLng(0, 0);

            var map = new L.Map('map', {center: latlng, zoom: 2, layers: [tiles]});

            var markers = new L.MarkerClusterGroup();
            var markersList = [];

            function populate() {
                for (var i = 0; i < countries.features[0].features.length; i++) {
                    const [lng, lat] = countries.features[0].features[i].geometry.centroid

                    var m = new L.MarkerClusterGroup();
                    const { total_course_count, continent, name } = countries.features[0].features[i].properties
                    console.log(countries.features[0].features[i].properties)
                    m.name = name
                    console.log('Marker', m);
                    m.on('clusterclick', function() {
                        console.log('Clicked on a country', this.name)
                        const countryHeader = document.getElementById('country-name');
                        while (countryHeader.firstChild) {
                            countryHeader.removeChild(countryHeader.firstChild);
                        }
                        const countryText = document.createTextNode(this.name);
                        countryHeader.appendChild(countryText)
                    })
                    for (let j = 0; j < total_course_count; j++) {
                        var marker = new L.marker({lat, lng}).addTo(m);

                    }

                    m.addTo(map);
                }
                return false;
            }
            function populateRandomVector() {
                for (var i = 0, latlngs = [], len = 20; i < len; i++) {
                    latlngs.push(getRandomLatLng(map));
                }
                var path = new L.Polyline(latlngs);
                map.addLayer(path);
            }
            function getRandomLatLng(map) {
                var bounds = map.getBounds(),
                    southWest = bounds.getSouthWest(),
                    northEast = bounds.getNorthEast(),
                    lngSpan = northEast.lng - southWest.lng,
                    latSpan = northEast.lat - southWest.lat;

                return new L.LatLng(
                        southWest.lat + latSpan * Math.random(),
                        southWest.lng + lngSpan * Math.random());
            }


            populate();

        </script>


        <div class="table-container">
            <table id="sites" class="table table-bordered table-responsive table-sm">
                <thead>
                <tr>
                    <th>Site Type</th>
                    <th>Name</th>
                    <th>Url</th>
                    <th>Course Count</th>
                </tr>
                </thead>
                <tfoot>
                <tr>
                    <th>Site Type</th>
                    <th>Name</th>
                    <th>Url</th>
                    <th>Course Count</th>
                </tr>
                </tfoot>
            </table>
        </div>
    </body>

{% endblock %}
