{% extends "base.html" %}
{% load bootstrap3 %}
{% load staticfiles %}
{% block bootstrap3_extra_head %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
    crossorigin="" />
<link rel="stylesheet" href="../../static/sites/MarkerCluster.css" />
<link rel="stylesheet" href="../../static/sites/MarkerCluster.Default.css" />
<link rel="shortcut icon" href="{%  static 'sites/favicon.ico' %}">

<style>
    #map {
        height: 750px;
    }
</style>

{{ form.media }}
{% endblock %}
{% block title %}
{% endblock %}
{% block content %}

<!-- Content -->
<div class="container-fluid">
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js" integrity="sha512-WXoSHqw/t26DszhdMhOXOkI7qCiv5QWXhH9R7CgvgZMHz1ImlkVQ3uNsiQKu5wwbbxtPzFXd1hK4tzno2VqhpA=="
    crossorigin=""></script>
    <script src="../../static/sites/leaflet.markercluster-src.js"></script>
    <script src="../../static/hawthorn_map/keyCountries.js"></script>
    <script src="../../static/hawthorn_map/main.js"></script>
    <script type="text/javascript">
        var tiles = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYnJ5YW5rbGUiLCJhIjoiY2pqMGNvdTc4MGYxMDNrcDE4a2c0Y3ltcyJ9.7KV9GmiOap9nsGiI12RGZg', {
            id: 'mapbox.emerald',
            maxZoom: 5,
        }),
        // Initial map location after load
        latlng = new L.LatLng(25, 0);
        console.log('keyCountries', keyCountries)
        // Primary layer, clusters will be appended to this layer
        var map = new L.Map('map', { center: latlng, zoom: 2, layers: [tiles] });

        // Continent clusters
        var northAmericaCluster = new L.MarkerClusterGroup().addTo(map);
        var southAmericaCluster = new L.MarkerClusterGroup().addTo(map);
        var asiaCluster = new L.MarkerClusterGroup().addTo(map);
        var africaCluster = new L.MarkerClusterGroup().addTo(map);
        var europeCluster = new L.MarkerClusterGroup().addTo(map);
        var oceaniaCluster = new L.MarkerClusterGroup().addTo(map);

        console.log('test')

        // Inspects entries array containing Hawthorn user data and places markers into
        // appropriate continent.
        function populate(entries) {
            console.log('populating')
            for (var i = 0; i < entries.length; i++) {
                const data = entries[i];
                const country = data[2];
                const countryData = keyCountries[country];
                if (keyCountries.hasOwnProperty(country)) {
                    const [lng, lat] = countryData.geometry.coordinates;
                    const continent = countryData.properties.continent;
                    const countryCluster = new L.MarkerClusterGroup();
                    const marker = new L.marker({ lat, lng }).addTo(countryCluster);
                    if (continent === 'Asia') {
                        asiaCluster.addLayer(countryCluster);
                    }
                    else if (continent === 'Africa') {
                        africaCluster.addLayer(countryCluster);
                    }
                    else if (continent === 'South America') {
                        southAmericaCluster.addLayer(countryCluster);
                    }
                    else if (continent === 'North America') {
                        northAmericaCluster.addLayer(countryCluster);
                    }
                    else if (continent === 'Europe') {
                        europeCluster.addLayer(countryCluster);
                    }
                    else if (continent === 'Oceania') {
                        oceaniaCluster.addLayer(countryCluster);
                    }
                }
            }
        }
        // GET request for CSV
        $.ajax({
            url: "{% url 'sites:hawthorn_map_json' %}",
            dataType: 'json',
            success: function (data) {
                console.log('AJAX success', data);
                const entries = JSON.parse(data.hawthorn_user_data);
                // Remove CSV table header
                entries.shift();
                populate(entries);
            }
        });
    </script>
</div>
{% endblock %}
